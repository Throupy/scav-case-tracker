<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-danger">Case Type Distribution</h6>
    </div>

    <div class="card-body">
        <div class="chart-pie">
            <canvas id="caseTypeDistribution"></canvas>
        </div>
        <div class="mt-4 text-center small">
            _
        </div>
    </div>
</div>

<script>
    function applyPieTheme(chart) {
        if (!chart) return;

        const dark = document.documentElement.classList.contains("dark");

        chart.options.plugins.legend.labels.color = dark ? "#ffffff" : "#858796";

        chart.options.plugins.tooltip.backgroundColor = dark ? "#151924" : "#ffffff";
        chart.options.plugins.tooltip.titleColor = dark ? "#ffffff" : "#6e707e";
        chart.options.plugins.tooltip.bodyColor = dark ? "#ffffff" : "#858796";
        chart.options.plugins.tooltip.borderColor = dark ? "#2a3142" : "#dddfeb";
        chart.options.plugins.tooltip.borderWidth = 1;

        chart.update();
    }

    let _pieChart = null;

    async function fetchDistributionData() {
        const days = window.dashboardDays || 0;
        const url = "/api/scav-case-type-distribution" + (days > 0 ? "?days=" + days : "");
        try {
            const r = await fetch(url);
            const resp = await r.json();
            const labels = Object.keys(resp.data);
            const values = Object.values(resp.data);

            if (_pieChart) {
                _pieChart.data.labels = labels;
                _pieChart.data.datasets[0].data = values;
                _pieChart.update();
            }
        } catch (e) {
            console.error("Error fetching Scav Case Type Distribution data:", e);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById("caseTypeDistribution");

        _pieChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: [],
                datasets: [
                    {
                        label: "Scav Case Type Distribution",
                        data: [],
                        backgroundColor: ["#4e73df", "#1cc88a", "#36b9cc", "#f6c23e", "#e74a3b"],
                        hoverBackgroundColor: ["#4e73df", "#1cc88a", "#36b9cc", "#f6c23e", "#e74a3b"],
                    },
                ],
            },
            options: {
                maintainAspectRatio: false,
                devicePixelRatio: 3,

                cutout: "50%",

                plugins: {
                    legend: {
                        display: true,
                        position: "top",
                        labels: {
                            // color will be set by applyPieTheme()
                        },
                    },
                    tooltip: {
                        enabled: true,
                        displayColors: false,
                        padding: 15,
                        caretPadding: 10,
                    },
                },
            },
        });

        applyPieTheme(_pieChart);

        document.addEventListener("theme:changed", function () {
            setTimeout(() => applyPieTheme(_pieChart), 0);
        });

        document.addEventListener("dashboard:time-changed", fetchDistributionData);

        fetchDistributionData();
    });

</script>
